cmake_minimum_required(VERSION 3.17)
project(SaintCore LANGUAGES CXX)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º C++17, –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç LibTorch
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# üîß –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ LibTorch –¥–ª—è CMake
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–π—Ç–∏ –∏ Torch, –∏ Caffe2 (–∫–æ—Ç–æ—Ä—ã–µ –ª–µ–∂–∞—Ç –≤–Ω—É—Ç—Ä–∏ libtorch)\
list(APPEND CMAKE_PREFIX_PATH "${CMAKE_SOURCE_DIR}/libtorch")


# üîç –ò—â–µ–º LibTorch
find_package(Torch REQUIRED)

# –í–∫–ª—é—á–∞–µ–º –≤–∞—à–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
include_directories(.)
include_directories(include)
include_directories(include/perfect_visualization)

# üîß –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
add_executable(SaintCore
        src/functions.cpp
        src/model.cpp
        src/tensor.cpp
        main.cpp
        visualization.cpp
        src/Image.cpp
        src/bmp_writer.cpp
        mnist_reader.cpp
)

# –õ–∏–Ω–∫—É–µ–º LibTorch
target_link_libraries(SaintCore PRIVATE ${TORCH_LIBRARIES})

# –î–ª—è Windows: –∫–æ–ø–∏—Ä—É–µ–º DLL –∏–∑ libtorch/bin —Ä—è–¥–æ–º —Å .exe
if (WIN32)
    file(GLOB TORCH_DLLS "${CMAKE_SOURCE_DIR}/libtorch/lib/*.dll")
    add_custom_command(TARGET SaintCore POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            ${TORCH_DLLS}
            $<TARGET_FILE_DIR:SaintCore>
    )
endif()

# üéØ GoogleTest
include(FetchContent)
FetchContent_Declare(
        googletest
        GIT_REPOSITORY https://github.com/google/googletest.git
        GIT_TAG        v1.14.0
)
FetchContent_MakeAvailable(googletest)

add_executable(SaintCoreTests
        src/functions.cpp
        src/model.cpp
        src/tensor.cpp
        tests/test_functions.cpp
        tests/test_tensor.cpp
        tests/test_model.cpp
)
target_include_directories(SaintCoreTests PRIVATE ${CMAKE_SOURCE_DIR}/include)
target_link_libraries(SaintCoreTests PRIVATE gtest_main)

enable_testing()
include(GoogleTest)
gtest_discover_tests(SaintCoreTests)
